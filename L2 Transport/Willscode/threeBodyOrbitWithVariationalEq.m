%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Variational equation which when integrated%%%   yields the state transition matrix%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%function Zdot = threeBodyOrbitWithVariationalEq(t,M)    global params;        % state to be integrated    x = M(1);    y = M(2);    vx = M(3);    vy = M(4);              % state transition matrix to be integrated    Phi = [M(5:8) M(9:12) M(13:16) M(17:20)];            % Distance from primary mass (Sun) and secondary mass (planet) to    %   spacecraft - r1 and r2 respectively.    r1 = sqrt((x+params.mu)^2 + y^2);    r2 = sqrt((x-1+params.mu)^2 + y^2);        % Gradient and Hessian of effective potential function    U_barx = -x + (1-params.mu)*(x+params.mu)/(r1^3) + params.mu*(x-1+params.mu)/(r2^3);    U_bary = -y + (1-params.mu)*y/(r1^3) + params.mu*y/(r2^3);              Ubar_xx = -1 + (1-params.mu)*((r1^3-3*(x+params.mu)^2*r1)/r1^6) + params.mu*((r2^3-3*(x-1+params.mu)^2*r2)/r2^6);    Ubar_yy = -1 + (1-params.mu)*((r1^3-3*y^2*r1)/r1^6) + params.mu*((r2^3-3*y^2*r2)/r2^6);    Ubar_xy = -3*y*(((1-params.mu)*(x+params.mu)/r1^5) + (params.mu*(x-1+params.mu)/r2^5));    Ubar_yx = Ubar_xy;        % 2D CR3BP dynamics    Zdot(1,1) = vx;    Zdot(2,1) = vy;    Zdot(3,1) = 2*vy - U_barx;    Zdot(4,1) = -2*vx - U_bary;    % Variational equation    Df = [       0,        0,  1, 0;                 0,        0,  0, 1;          -Ubar_xx, -Ubar_xy,  0, 2;          -Ubar_yx, -Ubar_yy, -2, 0];        Phi_dot = Df*Phi;        Zdot(5:8,1) = Phi_dot(:,1);    Zdot(9:12,1) = Phi_dot(:,2);    Zdot(13:16,1) = Phi_dot(:,3);    Zdot(17:20,1) = Phi_dot(:,4);    end